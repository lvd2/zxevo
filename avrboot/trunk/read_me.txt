
        BOOTLOADER ATMEGA128 для ZX Evolution

Шить ZXEVO_BL.HEX
или ZXEVO_BL.E2P (Для PonyProg2000. В файле E2P нужные фузы уже установлены).
Коммандная строка для AVREAL (ByteBlaster на LPT1):
avreal32.exe -ab -p1 +ATMEGA128 -e -w zxevo_bl.hex -f_low=3F,_high=88,_ext=FF,_lock=EF -v

Данные для загрузки (основная прошивка) ZXEVO_FW.BIN

------------------------------------------------------------------------------

        TECH INFO

- CRC -

Boot-блок и основная прошивка защищены CRC-16 (CCITT).
Вычисление и запись в прошивку автоматизировано с помощью доп.утилит.
Значения кладутся в последние два байта
для boot-блока $1FFFE/$1FFFF и для основной прошивки $1DFFE/$1DFFF
(старший байт первый).


- Версии -

 Версия представляет собой идентификатор прошивки, которая располагается
в последних адресах boot-блока ($1FFF0-$1FFFD)
и основной прошивки ($1DFF0-$1DFFD).

Состав идентификатора следующий:

 +00..+11 - произвольная символьная строка, добитая до длины 12 байт нулями
 +12..+13 - 16-битная величина в формате big-endian (старший байт первый),
            обозначающая дату релиза данной версии.

Формат 16-битной величины (биты пронумерованы начиная с младшего номером ноль)

бит  15     - бит "официальности"
биты 14..09 - год даты (8...63), 6 бит
биты 08..05 - месяц даты (1..12), 4 бита
биты 04..00 - день даты (1..31), 5 бит

Запись в прошивку автоматизировано с помощью доп.утилит. Разработчику нужно
лишь заполнить(изменить) строчку в файле VERSION.TXT перед компиляцией.


- Fuse Bits -

CKOPT=0, CKSEL321=111, (see Table 8)
CKSEL0=1, SUT10=11 (see Table 9)
Ext. Crystal/Resonator High Freq.; Start-up time: 16K CK + 64 ms

BODEN=0, BODLEVEL=0
Brown-out Detector level at 4.0 V

BOOTRST=0
Вектор сброса на boot-блок

BOOTSZ10=00
Размер boot-блока 8кб

EESAVE=1
При ChipErase стирать EEPROM

SPIEN=0
Программирование через ISP разрешено

JTAGEN=0
JTAG разрешён

OCDEN=1
On-chip Debug запрещён

M103C=1
Режим совместимости с ATMEGA103 отключен

WDTON=1
Watchdog Timer по-умолчанию запрещён (see Table 21 and around)

BLB1=10
Запись в область boot-блока коммандой SPM запрещена (see Table 116)



==============================================================================
v100117  (DDp)
~~~~~~~~~~~~~~
Ожидание CONF_DONE после загрузки FPGA.
Включение БП ATX проверяется не по цепи PowerGood, а по VCC5
(плюс доп.задержка 0.5 сек)
Более корректная работа со значениями из таблиц FAT32.
(появление ошибки было маловероятно)

==============================================================================
v091225  (DDp)
~~~~~~~~~~~~~~
Исправлена критическая ошибка в процедуре инициализации SD-карты.
(зависание при иниц.)

==============================================================================
v091219  (DDp)
~~~~~~~~~~~~~~
Поддержка ATX.
Поддержка версий (отображение в терминале версий [строка, дата,
официальность] загрузчика и основной программы).

==============================================================================
2009.11.26  v0.04  (DDp)
~~~~~~~~~~~~~~~~~
Просто пересборка в контексте svn (автоматизация сборки).
Упаковка fpga mhmt с окном 4096.

==============================================================================
2009.10.16  (DDp)
~~~~~~~~~~
(промежуточная версия)
+ обновление с SD-карточки

Особенности/ограничения:
Код работы с FAT списан с NeoLightPlayer by Savelij
соответственно, все его ограничения (плюс, возможно, свои глюки)
 > FAT12, FAT16, FAT32
 > MMC не поддерживаются
 > фиксированное имя файла прошивки (ZXEVO_FW.BIN)
 > поиск файла только в корневой директории (первого раздела)

КАК:
Удерживаем SoftReset по вкл.питания или по HardReset-у.
Сначала идёт попытка обновиться с SD.
При ошибке пищит бипером и переходит
в ожидание приёма данных по COM порту.
Через минуту перезапуск bootloader-а.

Формат данных для SD и для COM порта одинаков (делает программа MAKE_FW (ex MAKEBIN)).

NEXT:
? Кроме св.диода и бипера (и факта запуска основной прошивки)
  нет никаких других средств оповещения о удаче/ошибке обновления.
? Прошивальщика flash-rom нет, т.к. всё необходимое
  не вмещается в 8 килобайт бутблока. Тут,
  или "вылазим" за границу 8К,
  или заливаем fpga через COMпорт,
  или ...
  (Я так понимаю "основной" флёшер будет на Z80,
  а этот как аварийный/первоначальный.)

(на данный момент без "свистелок" свободно ~1.7Кб)




==============================================================================
2009.09.27  (DDp)
~~~~~~~~~~
> 1. Бут-загрузчик должен быть прозрачен по отношению к основной программе. Другими словами, основная
> программа пишется так, чтобы она работала без загрузчика, а загрузчик - так, чтобы основная программа
> продолжала корректно работать и с ним

Выполняется

> 2. Бут-загрузчик должен апдейтить программу атмеги через COM-порт

Выполняется

> ... файл для апдейта должен иметь общепринятую структуру, а для заливки не должно использоватся
> платформо-зависимое ПО.

Все таки, настаиваю на...
Формат файла - свой формат, бинарный с CRC внутри + заголовок
  (подготавливается отдельной тулзой - MAKEBIN)
Протокол заливки - XModem-CRC

> 5. Загрузчик должен запускать основную прошивку тоже через ресет. В дополнение к требованию прозрачности
> это влечёт за собой следующий механизм: загрузчик проверяет тип ресета, если это был watchdog-ресет, то
> безусловный запуск основной прошивки. Если любой другой - то проверка необходимости запуска загрузчика,
> в случае отсутствия - запуск основной прошивки. Таким образом, переход на основную прошивку осуществляется через
> watchdog-ресет.

(ну, если хочется...)
Сделано так:
При ресете проверяется его причина.
Если это не PowerOn и не ExtReset, то переход на 0.
Иначе начинает работать бутлоадер.
Он проверяет CRC себя, кнопки обновления, CRC основной программы.
Если кнопки не нажаты и CRC в порядке обнуляет флаги ресета PowerOn, ExtReset
и запускает WatchDog.
Иначе процедура(ы) обновления.


Условие принудительного запуска обновителя:
с COM-порта - нажатая кнопка SoftReset при включении
с SD-карты - ???

Обновление осуществляется по протоколу XModem-CRC с помощью
любого (нормального) терминала.
Протокол XModem-CheckSum не поддерживается.

Сделаны некоторые упрощения в реализации приёмника XModem.
(Например, игнорируются номера пакетов. При локальной работе появление
сбоев и повторов пакетов очень маловероятно.)

Настройки порта для терминала:
115200 бод,
8 бит данных,
без проверки на чётность,
1 или 2 стоповых бита,
без управления потоком (flow control - none)

В порте используются только линии Rx и Tx
Нульмодемный кабель может содержать только три провода.

На данный момент (2009.09.27) размер бутлоадера (минимальный
вариант - обновление только по COM порту) 626 байт.
Инициализатор SPI, распаковщик MLZ, заливальщик FPGA добавляют ~250 байт.

Проверено с
- HyperTerminal (WinXP),
- Telix v3.21 (DOS),
- Term95 v3.0 (DOS).
- терминал, встроенный в Dos Navigator II Open Source 1.51.03/DOS (DOS)


Доп.тулзы.

CRCBL128 считает crc для бутлоадера. (перепишу)

MAKEBIN считает crc для основной программы.
Открывает HEX, сохраняет BIN с тем же именем.
В начале BIN-файла 128-байтный заголовок.
В заголовке
 1) сигнатура (6 байт)
 2) комментарий (до 57 байт)
 3) битовая карта блоков ("пустые" блоки не сохраняются в файл)
 4) crc заголовка
Вот этот BIN и подсовывать терминалу.


При прошивке данной версии установить фузы:

BOOTRST=0 (Programmed)
BOOTSZ0=0 (Programmed)
BOOTSZ1=0 (Programmed)




==============================================================================
14.09.09: lvd
 initial release


Что должен и не должен делать бут-загрузчик: список требований и пожеланий

I. для чего предназначается бут-загрузчик в atmeg'e?
 Для возможности апдейта основной прошивки атмеги без применения программатора.

II. основные требования.

 1. Бут-загрузчик должен быть прозрачен по отношению к основной программе. Другими словами, основная
 программа пишется так, чтобы она работала без загрузчика, а загрузчик - так, чтобы основная программа
 продолжала корректно работать и с ним (при этом существует очевидное ограничение: длина основной
 программы - 120кБ).

 2. Бут-загрузчик должен апдейтить программу атмеги через COM-порт (обязательно),
 а также считывая прошивку атмеги с SD-карты (опционально) и уметь перешивать ПЗУ спектрума, беря прошивки
 из двух вышеуказанных источников (опционально).
 В обоих случаях файл для апдейта должен иметь общепринятую структуру, а для заливки не должно использоватся
 платформо-зависимое ПО. Оптимальным мне кажется вариант ihex'а (выхлоп любого девсофта под атмегу), а для
 заливки самое простое - использовать любую терминалку, или даже copy file.hex COM1: Можно сделать
 виндософтину с  кнопкой "ХАЧЮ!", но лишь как дополнение к изложенным требованиям. Такая софтина должна из себя
 представлять внутри ту же терминалку, только с автоматической заливкой.

 3. Для загрузки файлов с SD-карты, а также для перешивки ПЗУ спектрума, загрузчик должен загрузить в ФПГА
 свою специальную прошивку, предназначенную только для вышеуказанного. Эта спецйиальная прошивка занимает дошиша места
 (5-6 кило), запакованная, так что потому и опционально.

 4. Загрузчик должен в процессе своей работы инициализировать абсолютный минимум оборудования, например,
 инициализировать только требуемые для его работы пины, таймеры, коммуникационные интерфейсы. При этом
 допустимо полагать, что загрузчик начинает свою работу исключительно из reset'а.

 5. Загрузчик должен запускать основную прошивку тоже через ресет. В дополнение к требованию прозрачности
 это влечёт за собой следующий механизм: загрузчик проверяет тип ресета, если это был watchdog-ресет, то
 безусловный запуск основной прошивки. Если любой другой - то проверка необходимости запуска загрузчика,
 в случае отсутствия - запуск основной прошивки. Таким образом, переход на основную прошивку осуществляется через
 watchdog-ресет.

 6. Следует учитывать характер питания платы от АТХ-блока, а именно, что при ресете атмеги отключается
 основное питание платы, а запитанной остаётся лишь атмега с ком-портом и часиками. Лишний раз дёргать
 питание платы не стоит, откуда следует вывод, что пытаться перешиться из СД-карты загрузчик должен лишь
 в случае, если этого реально хочет юзер. Иначе при каждом сбросе поимеем двойной передёрг питания платы...

 7. выполнение функции загрузчика должно начинаться, лишь если этого реально хочет юзер, а не по желанию
 его левой пятки. Например, не считаю необходимым иметь пункт запуска загрузчика в OSD-меню основной программы.
 Перешиваются не каждый день, потому требование запуска должно быть, например такое: нажать и удерживать
 soft-reset при подаче hard-reset'а (или повероне).


добавления...

1. возможно получше паковать файл прошивки для фпга, если использовать под это не 2кило, а больше.
Если "больше"<4096, то настанет жуткий геморрой по зацикливанию укзаателей, потому "больше"=4096.
Так как бутлоадер пишется на ассемблере, то это не должно составить особой проблемы. Главное,
депакер не с сей переписывать, а взять z80-код ;)
