history:

14.09.09: lvd
 initial release

=======================================================================================

Что должен и не должен делать бут-загрузчик: список требований и пожеланий

I. для чего предназначается бут-загрузчик в atmeg'e?
 Для возможности апдейта основной прошивки атмеги без применения программатора.

II. основные требования.

 1. Бут-загрузчик должен быть прозрачен по отношению к основной программе. Другими словами, основная
 программа пишется так, чтобы она работала без загрузчика, а загрузчик - так, чтобы основная программа
 продолжала корректно работать и с ним (при этом существует очевидное ограничение: длина основной
 программы - 120кБ).

 2. Бут-загрузчик должен апдейтить программу атмеги через COM-порт (обязательно),
 а также считывая прошивку атмеги с SD-карты (опционально) и уметь перешивать ПЗУ спектрума, беря прошивки
 из двух вышеуказанных источников (опционально).
 В обоих случаях файл для апдейта должен иметь общепринятую структуру, а для заливки не должно использоватся
 платформо-зависимое ПО. Оптимальным мне кажется вариант ihex'а (выхлоп любого девсофта под атмегу), а для
 заливки самое простое - использовать любую терминалку, или даже copy file.hex COM1: Можно сделать
 виндософтину с  кнопкой "ХАЧЮ!", но лишь как дополнение к изложенным требованиям. Такая софтина должна из себя
 представлять внутри ту же терминалку, только с автоматической заливкой.

 3. Для загрузки файлов с SD-карты, а также для перешивки ПЗУ спектрума, загрузчик должен загрузить в ФПГА
 свою специальную прошивку, предназначенную только для вышеуказанного. Эта спецйиальная прошивка занимает дошиша места
 (5-6 кило), запакованная, так что потому и опционально.

 4. Загрузчик должен в процессе своей работы инициализировать абсолютный минимум оборудования, например,
 инициализировать только требуемые для его работы пины, таймеры, коммуникационные интерфейсы. При этом
 допустимо полагать, что загрузчик начинает свою работу исключительно из reset'а.

 5. Загрузчик должен запускать основную прошивку тоже через ресет. В дополнение к требованию прозрачности
 это влечёт за собой следующий механизм: загрузчик проверяет тип ресета, если это был watchdog-ресет, то
 безусловный запуск основной прошивки. Если любой другой - то проверка необходимости запуска загрузчика,
 в случае отсутствия - запуск основной прошивки. Таким образом, переход на основную прошивку осуществляется через
 watchdog-ресет.

 6. Следует учитывать характер питания платы от АТХ-блока, а именно, что при ресете атмеги отключается
 основное питание платы, а запитанной остаётся лишь атмега с ком-портом и часиками. Лишний раз дёргать
 питание платы не стоит, откуда следует вывод, что пытаться перешиться из СД-карты загрузчик должен лишь
 в случае, если этого реально хочет юзер. Иначе при каждом сбросе поимеем двойной передёрг питания платы...

 7. выполнение функции загрузчика должно начинаться, лишь если этого реально хочет юзер, а не по желанию
 его левой пятки. Например, не считаю необходимым иметь пункт запуска загрузчика в OSD-меню основной программы.
 Перешиваются не каждый день, потому требование запуска должно быть, например такое: нажать и удерживать
 soft-reset при подаче hard-reset'а (или повероне).


добавления...

1. возможно получше паковать файл прошивки для фпга, если использовать под это не 2кило, а больше.
Если "больше"<4096, то настанет жуткий геморрой по зацикливанию укзаателей, потому "больше"=4096.
Так как бутлоадер пишется на ассемблере, то это не должно составить особой проблемы. Главное,
депакер не с сей переписывать, а взять z80-код ;)

==============================================================================

14.09.2009 DDp

> при этом существует очевидное ограничение:
> длина основной программы - 120кБ

Ничего не мешает свободно двигать эту границу. Например, можно "откусить"
у основной программы кусок для задач бутлоадера.
Бут просто не даст обновлять эту область.

> ...файл для апдейта должен иметь общепринятую структуру...
> ...Оптимальным мне кажется вариант ihex'а ...

BIN с предподсчитанной CRC внутри.

> ... для заливки не должно использоватся платформо-зависимое ПО

Уговорил, XModem-CRC (XModem-CheckSum)

> ...потому требование запуска должно быть, например такое:
> нажать и удерживать soft-reset при подаче hard-reset'а (или повероне).

Предлагаю "B" на механической клавиатуре при hard-reset'е (или повероне).
При отсутсвии мех.клавы "B" иммитируется джампером на конт. 8-10 разъёма X12.

 - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

Есть бредовая идея, но думаю lvd будет против.
AVR имеет доступ к ОЗУ спектрума (через регистры fpga).
В ОЗУ с любого доступного носителя загружается новая прошивка.
Z80 каким-либо способом оповещает AVR (и передаёт указатель на данные)
AVR (bootloader) шьёт себя.
Если в процессе что-то пойдёт не так - останется аварийный способ по COMпорту.

==============================================================================
