Магик на пентеве.


1. ВВодится состояние NMI. Отличается тем, что в очко #0000-#3FFF принудительно
включается последняя (255ая) страница ОЗУ. Приоритет даже над включением 0 паги
рамы в #0000-#3FFF через бит в #EFF7.

Вход в состояние NMI происходит, собственно, по началу сигнала /NMI на
процессор.

При этом, вход не гарантируется и может привести к катастрофе, если /MNI
приходит во время команды, которая:
1) имеет стек области #0000-#3FFF
2) исполняется из области #0000-#3FFF
3) использует данные в области #0000-#3FFF
В случаях 1 и 3 также может нарушиться целостность данных в последней странице
ОЗУ.


2. предлагается ввести порт #BE (чтение-запись).

на чтение - можно будет считать состояние портов #7FFD, #EFF7, #xx77, состояние
менеджера памяти. Что читаем - определяется старшим адресным байтом.

Конкретные адреса и что читается:

#00BE..#07BE: - номера включенных страниц в очках, НЕИНВЕРТИРОВАННЫЕ.
00..03 - очки 0..3 для нулевой карты памяти (бит 4 7ффд = 0)
04..07 - то же самое для единичной карты памяти (бит 4 7ффд = 1)

#08BE: биты RAM/ROM для всех очек и карт памяти, биты с номерами 0..7
распределены так же, как и ячейки 00..07 выше.

#09BE: биты dos/7ffd. так же.

Примечание: биты dos/7ffd и RAM/ROM для случая ROM можно ставить только через
порты #xFF7. Старшие 2 бита номера страницы можно поставить только через порты
#x7F7, при этом установится бит RAM/ROM и останется неизменным бит dos/7ffd.
Таким образом, алгоритм восстановления на основе ранее считанных данных
#00BE..#09BE может быть таким:
1. Записывая в #xFF7, восстановить все биты dos/7ffd
2. если страница ROM или RAM и её номер <64, восстановить её записью в #xFF7
   одновременно с пунктом 1.
3. Для всех RAM-страниц с номерами >=64 восстановить номер страницы
   дополнительной записью в соответствующий порт #x7F7.
4. В пунктах 2-3 не забывать про инверсию номера страницы при записи.

#0ABE: последнее записанное значение в порт #7FFD.

#0BBE: последнее записанное значение в порт #EFF7.

#0CBE: последнее записанное значение в порт #xx77. значение бит следующее:

 биты 3..0 - последнее записанное значение в биты 3..0 порта #xx77
 бит 7 - последнее записанное значение A14 при записи в #xx77
 бит 6 - --//-- A9 --//--
 бит 5 - --//-- A8 --//--

проблема - палитра.





Порт #BF сам по себе (рид-райт)




на запись - после факта записи в порт #BE, если находимся в состоянии NMI, на
2ой по счёту /RFSH выключаем это состояние.

Таким образом выход из NMI происходит так

  POP <все регистры>
  OUT (#BE),A
  RETN

