short-list:

порты, которых нету в DOS и ATM режиме: xxf7 (часики, eff7), xx77 (сд-карта), xx1f (жопстик)
порты, коотрые появляются в DOS и ATM режиме: порты контроллера нгмд,
порт xx77 (atm config), порт xxf7 (atm paging)
порты, которые есть всегда: xxbf (zxevo config)

dos, он же atm режим - режим, когда доступны атмные порты и всё. Не имеет отношения к страницам памяти и т.д.,
только какие порты видны и всё.

существует сигнал включения портов атм: shadowen (так я его буду называть),
именно он определяет, какой набор из портов (см. выше) доступен.
В старом АТМ и по дефолту в zxevo этот сигнал равен сигналу dosen: когда включено пзу
трдоса, тогда и сигнал это включен. Однако существует порт BF:

адрес: $xxBF, write-only
бит 0: если=0, то shadowen=dosen, если=1, то shadowen=1 всегда (всегда включен АТМ режим, определение режима см. выше).
бит 1: если=0, то запись в flash блокируется, если=1, то запись в flash не блокируется (можно перешивать прям в компе).
после сброса - все биты 0.


другой порт как в ATM2:

адрес: $xx77, write-only, см. доку на АТМ2.

A8 - если=0, во все очки втыкается пзу с глюком (в оригинале было - с цмп). Лучше держать в 1.
A9 - если=0, то принудительно включается dosen (а значит и shadowen), как в оригинальном АТМ2. Для программ zxevo-only
     лучше юзать порт $BF. Если есть нужна выставить что-то в xx77, надо прочитать доку по АТМ2 и остальные биты данных
     адресов выставить соответствующим образом. Пока эти остальные биты не реализованы.


Порты управления памятью:

адрес: $xxF7, write-only, см. доку на АТМ2 + дополнения.

A15,A14 - определяют очко, на которое применить страничку.

если порты 3FF7, 7FF7, BFF7, FFF7 - как в АТМ2 биты:
бит 7: =0 - 7FFD не участвует, =1 - участвует в младшие куски номера.
       ВНИМАНИЕ! в режиме п1024к, включенном через eff7, 7ffd влияет уже не на 3 младших бита, а на все 6!
бит 6: =0 - включается ПЗУ, =1 - ОЗУ.

биты 5-0: инверсные биты номера страниц.

если порты 37F7, 77F7, B7F7, F7F7 - дополнительнеые порты.

все биты идут на номер страницы (итого 4 мегабайта). Биты тоже инверсные, FF - страница 00 и т.д.

Внимание! При выводе в порты x7F7, значения бита 7 от соответсвующего порта xFF7 сохраняется! т.е. если в
3FF7 был выставлен бит 7=1, то потом при выводе в 37F7 в младшую часть номера всё равно воткнётся 7FFD
(его 3 или 6 бит). Также при выводе в x7F7 включается ОЗУ! ПЗУ только через xFF7.

Про порт 7FFD и его бит 4 не пишу, есть в доке на АТМ2.





==============================================================================
Буду тут думать об том, как атм модес впихать в пентеву.
Поначалу речь пойдёт об манагере памяти и всём что с ним связано.

рассмотрим атм2.
Там применён оригинальный манагер памяти 1м, который позволяет флипать любую из 16к очек процессора.
Для совместимости с 128к моде было сделано следующее.
1 - добавлены 2 карты памяти, переключаемые с помощью бита из 7ффд, который раньше переключал пзухи
2 - сделан режим, когда младшие 3 бита номера страницы в данном очке могут подменяться на д0-д2 из 7ффд.
При помощи такой хуебени эмулируется обычная карта памяти 128к спека.
Сильная залочка на ДОСЕН и гадское трдос - я не понял например, можно ли без постоянной дрочки
ДОСЕН- не ДОСЕН вклчать любую страничку ПЗУ и работать с ней.

что требуется
1 - поддержать режим атм-компатибилити.
2 - расширить адресацию страниц озу до 4 метров
3 - интегрировать режим п1024к в атмо-режимы.



Волевые решения:

x. Для того, чтобы уйти от ебенимуттерного call #3d2f, ввести доп. порт (порты), в которых
   можно рулить всякими ДОСЕНАми, открытостью теневых портов, режимом 4мб и прочими поебнями
   Предлагается $xxBF. Данный порт замечен ранее в дивИДЕ, которая в силу своей ущербности и
   невозможностью работы на любом спекоклоне с (НЕМО)ЗХ-БАС идет нахрен сразу и навсегда.
   Порт этот должен быть всегда открыт и доступен. Ибо см. выше про call #3d2f.

x. В этом порту разделить сигналы DOSEN (включение пзу трдос при помощи см. выше чего и выключение
   при помощи исполнения из ОЗУ) и сигнал включения теневых портов шедоуен (в том числе и ВГ93). ПРи
   этом, ессно, в отсутствии дрочки этого порта должен работать обычный механизьм с досен=шедоуен,
   залочкой досен по стандарту АТМ2 и проч.

x. Режим 4м должен реализоваться так: выводя в порты 3ff7/7ff7/bff7/fff7 - адресуемся в пределах 1 метра
   пзу или озу, как в атм1м. Выводя же в порты 37f7, 77f7, b7f7, f7f7 - включаем в соответствующее очко
   ОЗУ в пределах 4 мегабайт (тоже инверсные биты, ибо нефиг). 1м режимы адресуют страницы с номерами 00-3f,
   из всего набора 4м 00-фф. соотв-но чтобы 4м-адресацией адресануть страницу номер 00, выводим число ff
   (ибо инверсия). В портах xFF7 D7 - определяет, впечатываются ли младшие биты из 7FFD. При записи в
   x7F7 этот бит сохраняется! т.е. адресуясь в 4 метрах, можно младшие биты из 7FFD втыкать, для чего надо
   вначале записать что-то в xFF7.

x. В режиме пентагона есть порты xxФ7 (часы + порт ефф7) и хх77 (порт СД-карты, придуманный КОЕ-как).
   Оба они перекрываются атмными портами. Потому делаем тупо - пусть в пентагоновом режиме пентагоновы порты,
   а в атмном режиме - атмные. Как стучать в часы и сдкарту из атм - включая режим пятногона через ххБФ, видимо.
   Вариант - можно по сигналу шедоуен переключаться.

x. Интеграция с п1м модой: вместо 3 бит в режиме п1м заменяются 6 бит. И всё. :)
   При этом все Очки работают штатно. Исключение - рам0 в 0 очкО - имеет приоритет над атм-стайл очком.

x. Следствием является то, что перед работой в режиме п1м надо настроить карты памяти. Или же сделать так,
   чтоб они дефолтно настраивались по сбросу (предпочтительнее).

xxBF:
 0 - shadowen control: 0 - shadowen=dosen, 1 - shadowen=1
 1 - ROMRW: 0 - ROM is read-only (no /WE), 1 - ROM is read-write (/WE)





==============================================================================
DDp (01.03.2010)

1) АТМ(2) для меня умер. Я хочу Пентагон с (линейным) текстовым режимом.  ;)

2) сигнал ROM2 активно используется в BIOS-е CP/M для быстрого переключения двух карт памяти
(при чём делается это через OUT (#FD),A  ,где A = #52, либо #42)
В xBIOS-е, вроде, тоже.

3) Вариант режима 4М: использовать доп. бит(ы) в ст.адресе порта F7.
Например,
запись в BFF7 программирует конфигурацию третьей четвертинки "по-старому";
запись в B7F7 устанавливает номер страницы ОЗУ, все 8 бит (можно без инверсии);
запись в BBF7 устанавливает номер страницы ПЗУ, все 8 бит (можно без инверсии).

4) Очертить круг TURBO2-программ, с которыми желательна совместимость и сделать всё чтобы они работали.
Если таких програм окажется немного - смотреть, можно ли их модифицировать для работы с другой(новой) архитектурой.
==============================================================================

